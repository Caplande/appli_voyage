<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Application de Voyage</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        fieldset { margin-bottom: 20px; }
        legend { font-weight: bold; }
        label { display: block; margin-top: 5px; }
        input, select { width: 200px; margin-top: 3px; }
        button { margin-top: 10px; }
        .result { margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>

<h1>Application de Voyage</h1>

<!-- Menu permanent -->
<fieldset>
    <legend>Menu</legend>
    <button onclick="showSection('voyageSection')">Cr√©er un voyage</button>
    <button onclick="showSection('membreSection')">Cr√©er un membre</button>
    <button onclick="showSection('depenseSection')">Ajouter une d√©pense</button>
</fieldset>

<!-- Section Cr√©ation Voyage -->
<fieldset id="voyageSection" style="display:none;">
    <legend>Cr√©er un voyage</legend>
    <form id="voyageForm">
        <label for="voyageNom">Nom :</label>
        <input type="text" id="voyageNom" required>

        <label for="voyageCommentaire">Commentaire :</label>
        <input type="text" id="voyageCommentaire">

        <label for="voyageDebut">Date de d√©but :</label>
        <input type="date" id="voyageDebut" required>

        <label for="voyageFin">Date de fin :</label>
        <input type="date" id="voyageFin" required>

        <button type="submit">Cr√©er</button>
    </form>
    <div class="result" id="voyageResult"></div>
</fieldset>

<!-- Section Cr√©ation Membre -->
<fieldset id="membreSection" style="display:none;">
    <legend>Cr√©er un membre</legend>
    <form id="membreForm">
        <label for="membreNom">Nom :</label>
        <input type="text" id="membreNom" required>

        <label for="membrePrenom">Pr√©nom :</label>
        <input type="text" id="membrePrenom" required>

        <label for="membreMail">Email :</label>
        <input type="email" id="membreMail">

        <label for="membreMobile">Num√©ro mobile :</label>
        <input type="text" id="membreMobile">

        <label for="voyageSelectMembre">Voyage :</label>
        <select id="voyageSelectMembre"></select>

        <button type="submit">Cr√©er membre</button>
    </form>
    <div class="result" id="membreResult"></div>
</fieldset>

<!-- Section Ajout D√©pense -->
<fieldset id="depenseSection" style="display:none;">
    <legend>Ajouter une d√©pense</legend>
    <form id="depenseForm">
        <label for="depenseNom">Description :</label>
        <input type="text" id="depenseNom" required>

        <label for="depenseMontant">Montant :</label>
        <input type="number" step="0.01" id="depenseMontant" required>

        <label for="voyageSelectDepense">Voyage :</label>
        <select id="voyageSelectDepense"></select>

        <button type="submit">Ajouter d√©pense</button>
    </form>
    <div class="result" id="depenseResult"></div>
</fieldset>

<script>
// üîπ Gestion des sections
function showSection(sectionId) {
    ['voyageSection','membreSection','depenseSection'].forEach(id => {
        document.getElementById(id).style.display = (id === sectionId) ? 'block' : 'none';
    });
}

// üîπ Cr√©er un voyage
document.getElementById("voyageForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const nom = document.getElementById("voyageNom").value;
    const commentaire = document.getElementById("voyageCommentaire").value;
    const date_debut = document.getElementById("voyageDebut").value;
    const date_fin = document.getElementById("voyageFin").value;

    const resp = await fetch("/voyages/", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ nom, commentaire, date_debut, date_fin })
    });
    const data = await resp.json();
    document.getElementById("voyageResult").textContent =
        `Voyage cr√©√© : ${data.nom} (id=${data.id}) - ${data.commentaire || ""}`;

    loadVoyages();
});

// üîπ Cr√©er un membre
document.getElementById("membreForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const nom = document.getElementById("membreNom").value;
    const prenom = document.getElementById("membrePrenom").value;
    const mail = document.getElementById("membreMail").value;
    const mobile = document.getElementById("membreMobile").value;
    const voyage_id = document.getElementById("voyageSelectMembre").value;

    const resp = await fetch(`/membres/${voyage_id}/membres`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ nom, prenom, mail, mobile })
    });
    const data = await resp.json();
    document.getElementById("membreResult").textContent =
        `Membre cr√©√© : ${data.nom} ${data.prenom} (id=${data.id})`;
});

// üîπ Ajouter une d√©pense
document.getElementById("depenseForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const description = document.getElementById("depenseNom").value;
    const montant = parseFloat(document.getElementById("depenseMontant").value);
    const voyage_id = document.getElementById("voyageSelectDepense").value;

    const resp = await fetch(`/depenses/${voyage_id}/depenses`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ description, montant })
    });
    const data = await resp.json();
    document.getElementById("depenseResult").textContent =
        `D√©pense ajout√©e : ${data.description} (${data.montant}‚Ç¨)`;
});

// üîπ Charger les voyages pour dropdowns
async function loadVoyages() {
    try {
        const res = await fetch("/voyages/derniers_voyages");
        const data = await res.json();

        const selects = [
            document.getElementById("voyageSelectMembre"),
            document.getElementById("voyageSelectDepense")
        ];

        if (!data.voyages || data.voyages.length === 0) {
            selects.forEach(sel => {
                sel.innerHTML = "";
                const opt = document.createElement("option");
                opt.textContent = "Aucun voyage disponible";
                opt.disabled = true;
                sel.appendChild(opt);
            });
            return;
        }

        selects.forEach(sel => {
            sel.innerHTML = "";
            data.voyages.forEach(v => {
                const opt = document.createElement("option");
                opt.value = v.id;
                opt.textContent = v.commentaire
                    ? `${v.nom} (${v.date_debut} ‚Üí ${v.date_fin}) - ${v.commentaire}`
                    : `${v.nom} (${v.date_debut} ‚Üí ${v.date_fin})`;
                sel.appendChild(opt);
            });
            if (data.voyage_defaut_id) sel.value = data.voyage_defaut_id;
            else sel.selectedIndex = 0;
        });

    } catch (err) {
        console.error("Erreur lors du chargement des voyages :", err);
    }
}

// Charger voyages au d√©marrage
loadVoyages();
</script>

</body>
</html>
